name: Update Novel Status Embeds

on:
  repository_dispatch:
    types: [update-novel-status]

  workflow_dispatch:
    inputs:
      title:
        description: "Novel title"
        required: true
        type: string
      host:
        description: "Hosting site (e.g. Mistmint Haven)"
        required: true
        type: string

permissions:
  contents: read

concurrency:
  group: update-novel-status
  cancel-in-progress: false

jobs:
  update_status:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install \
            discord.py>=2.3 \
            requests>=2.31 \
            python-dateutil

      - name: Resolve payload
        run: |
          TITLE="${{ github.event.client_payload.title || github.event.inputs.title }}"
          HOST="${{ github.event.client_payload.host || github.event.inputs.host }}"

          if [ -z "$TITLE" ] || [ -z "$HOST" ]; then
            echo "âŒ Missing title or host"
            exit 1
          fi

          echo "TITLE=$TITLE" >> $GITHUB_ENV
          echo "HOST=$HOST" >> $GITHUB_ENV
          echo "SOURCE=${{ github.event.client_payload.source || 'manual' }}" >> $GITHUB_ENV

          echo "ðŸ”” Updating novel status for $TITLE ($HOST)"

      - name: Run updater
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        run: |
          python update_novel_status.py "$TITLE" "$HOST"
